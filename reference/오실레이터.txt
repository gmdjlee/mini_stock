from datetime import datetime, timedelta
import matplotlib.dates as mdates
import matplotlib.pyplot as plt
import pandas as pd
from pykrx import stock

# ============================================================================
# ì„¤ì • ìƒìˆ˜
# ============================================================================
EMA_FAST = 12  # ë‹¨ê¸° EMA ê¸°ê°„
EMA_SLOW = 26  # ì¥ê¸° EMA ê¸°ê°„
EMA_SIGNAL = 9  # ì‹œê·¸ë„ EMA ê¸°ê°„
ROLLING_WINDOW = 5  # ëˆ„ì  ê¸°ê°„ (5ì¼)
ANALYSIS_DAYS = 180  # ë¶„ì„ ê¸°ê°„ (6ê°œì›”)

# í•œê¸€ í°íŠ¸ ì„¤ì •
plt.rcParams["font.family"] = ["Malgun Gothic", "AppleGothic", "DejaVu Sans"][0]
plt.rcParams["axes.unicode_minus"] = False

# ============================================================================
# í•µì‹¬ ê³„ì‚° í•¨ìˆ˜
# ============================================================================
def calc_ema(series, period):
    """EMA ê³„ì‚°"""
    return series.ewm(alpha=2 / (period + 1), adjust=False).mean()


def get_data(ticker, start_date, end_date, verbose=True):
    """ë°ì´í„° ìˆ˜ì§‘"""
    if verbose:
        print(f"ğŸ“Š ë°ì´í„° ìˆ˜ì§‘: {ticker}")

    # ì‹œê°€ì´ì•¡ ë° íˆ¬ìì ê±°ë˜ ë°ì´í„°
    mcap = stock.get_market_cap(start_date, end_date, ticker)
    inv = stock.get_market_trading_value_by_date(start_date, end_date, ticker)

    if mcap.empty or inv.empty:
        raise ValueError("ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤. ì¢…ëª©ì½”ë“œì™€ ê¸°ê°„ì„ í™•ì¸í•˜ì„¸ìš”.")

    # DataFrame êµ¬ì„±
    df = pd.DataFrame(
        {
            "ì‹œê°€ì´ì•¡": mcap["ì‹œê°€ì´ì•¡"],
            "ì™¸êµ­ì¸_5ì¼": inv["ì™¸êµ­ì¸í•©ê³„"].rolling(ROLLING_WINDOW).sum(),
            "ê¸°ê´€_5ì¼": inv["ê¸°ê´€í•©ê³„"].rolling(ROLLING_WINDOW).sum(),
        }
    ).dropna()

    if verbose:
        print(f"âœ… ìˆ˜ì§‘ ì™„ë£Œ: {len(df)}ì¼\n")

    return df


def calc_oscillator(df, verbose=True):
    """ì˜¤ì‹¤ë ˆì´í„° ê³„ì‚°"""
    if verbose:
        print("ğŸ“ ì˜¤ì‹¤ë ˆì´í„° ê³„ì‚° ì¤‘...")

    # ìˆ˜ê¸‰ ë¹„ìœ¨
    df["ìˆ˜ê¸‰ë¹„ìœ¨"] = (df["ì™¸êµ­ì¸_5ì¼"] + df["ê¸°ê´€_5ì¼"]) / df["ì‹œê°€ì´ì•¡"]

    # MACD
    df["EMA12"] = calc_ema(df["ìˆ˜ê¸‰ë¹„ìœ¨"], EMA_FAST)
    df["EMA26"] = calc_ema(df["ìˆ˜ê¸‰ë¹„ìœ¨"], EMA_SLOW)
    df["MACD"] = df["EMA12"] - df["EMA26"]

    # ì‹œê·¸ë„ ë° ì˜¤ì‹¤ë ˆì´í„°
    df["ì‹œê·¸ë„"] = calc_ema(df["MACD"], EMA_SIGNAL)
    df["ì˜¤ì‹¤ë ˆì´í„°"] = df["MACD"] - df["ì‹œê·¸ë„"]
    df["ì‹œê°€ì´ì•¡_ì¡°"] = df["ì‹œê°€ì´ì•¡"] / 1e12

    if verbose:
        print(f"âœ… ê³„ì‚° ì™„ë£Œ: {len(df.dropna())}ì¼\n")

    return df.dropna()

# ============================================================================
# ì‹œê°í™” í•¨ìˆ˜
# ============================================================================
def setup_chart_style(ax, title, ylabel, grid=True):
    """ì°¨íŠ¸ ìŠ¤íƒ€ì¼ ê³µí†µ ì„¤ì •"""
    ax.set_title(title, fontsize=12, pad=10)
    ax.set_ylabel(ylabel, fontsize=10)
    if grid:
        ax.grid(True, alpha=0.3)
    ax.xaxis.set_major_formatter(mdates.DateFormatter("%Y-%m-%d"))
    ax.xaxis.set_major_locator(mdates.MonthLocator(interval=1))
    plt.setp(ax.xaxis.get_majorticklabels(), rotation=45, ha="right")


def plot_chart(df, name):
    """ì°¨íŠ¸ ìƒì„±"""
    fig, (ax1, ax2) = plt.subplots(
        2, 1, figsize=(15, 10), gridspec_kw={"height_ratios": [2, 1]}
    )
    fig.suptitle(f"{name} ìˆ˜ê¸‰ ì˜¤ì‹¤ë ˆì´í„°", fontsize=16, fontweight="bold")

    # ìƒë‹¨: ì‹œê°€ì´ì•¡ + ì˜¤ì‹¤ë ˆì´í„°
    ax1.plot(
        df.index, df["ì‹œê°€ì´ì•¡_ì¡°"], "b-", linewidth=2, label="ì‹œê°€ì´ì•¡", alpha=0.7
    )
    ax1_r = ax1.twinx()
    ax1_r.plot(
        df.index, df["ì˜¤ì‹¤ë ˆì´í„°"], "r-", linewidth=2, label="ì˜¤ì‹¤ë ˆì´í„°", alpha=0.7
    )
    ax1_r.fill_between(
        df.index,
        0,
        df["ì˜¤ì‹¤ë ˆì´í„°"],
        where=(df["ì˜¤ì‹¤ë ˆì´í„°"] > 0),
        color="green",
        alpha=0.2,
    )
    ax1_r.fill_between(
        df.index,
        0,
        df["ì˜¤ì‹¤ë ˆì´í„°"],
        where=(df["ì˜¤ì‹¤ë ˆì´í„°"] <= 0),
        color="red",
        alpha=0.2,
    )
    ax1_r.axhline(0, color="black", linestyle="--", linewidth=0.8, alpha=0.5)

    ax1.set_ylabel("ì‹œê°€ì´ì•¡ (ì¡°ì›)", color="b", fontsize=10)
    ax1_r.set_ylabel("ì˜¤ì‹¤ë ˆì´í„°", color="r", fontsize=10)
    ax1.tick_params(axis="y", labelcolor="b")
    ax1_r.tick_params(axis="y", labelcolor="r")
    ax1.legend(loc="upper left", fontsize=9)
    setup_chart_style(ax1, "ì‹œê°€ì´ì•¡ê³¼ ìˆ˜ê¸‰ ì˜¤ì‹¤ë ˆì´í„°", "")

    # í•˜ë‹¨: MACD ìƒì„¸
    ax2.plot(df.index, df["MACD"], "b-", linewidth=1.5, label="MACD", alpha=0.8)
    ax2.plot(
        df.index, df["ì‹œê·¸ë„"], color="orange", linewidth=1.5, label="ì‹œê·¸ë„", alpha=0.8
    )
    ax2.plot(
        df.index,
        df["ì˜¤ì‹¤ë ˆì´í„°"],
        color="purple",
        linewidth=2,
        label="ì˜¤ì‹¤ë ˆì´í„°",
        alpha=0.7,
    )
    ax2.fill_between(
        df.index,
        0,
        df["ì˜¤ì‹¤ë ˆì´í„°"],
        where=(df["ì˜¤ì‹¤ë ˆì´í„°"] > 0),
        color="green",
        alpha=0.2,
    )
    ax2.fill_between(
        df.index,
        0,
        df["ì˜¤ì‹¤ë ˆì´í„°"],
        where=(df["ì˜¤ì‹¤ë ˆì´í„°"] <= 0),
        color="red",
        alpha=0.2,
    )
    ax2.axhline(0, color="black", linestyle="--", linewidth=0.8, alpha=0.5)
    ax2.legend(loc="upper left", fontsize=9)
    setup_chart_style(ax2, "MACD ìƒì„¸", "MACD / ì‹œê·¸ë„ / ì˜¤ì‹¤ë ˆì´í„°")

    plt.tight_layout()

    # ì €ì¥
    filename = f"{name}_ìˆ˜ê¸‰ì˜¤ì‹¤ë ˆì´í„°_{datetime.now():%Y%m%d}.png"
    plt.savefig(filename, dpi=300, bbox_inches="tight")
    print(f"ğŸ’¾ ì°¨íŠ¸ ì €ì¥: {filename}\n")
    plt.show()

# ============================================================================
# ì‹ í˜¸ ë¶„ì„ í•¨ìˆ˜
# ============================================================================
def analyze(df):
    """ë§¤ë§¤ ì‹ í˜¸ ë¶„ì„"""
    recent = df.tail(1).iloc[0]
    prev = df.tail(2).iloc[0]

    print("=" * 60)
    print("ğŸ“ˆ ë§¤ë§¤ ì‹ í˜¸ ë¶„ì„")
    print("=" * 60)
    print(f"\nğŸ“… ìµœê·¼: {df.index[-1]:%Y-%m-%d}")
    print(f"ğŸ’° ì‹œì´: {recent['ì‹œê°€ì´ì•¡_ì¡°']:.2f}ì¡°")
    print(f"ğŸ“Š ì˜¤ì‹¤: {recent['ì˜¤ì‹¤ë ˆì´í„°']:.6f}")
    print(f"ğŸ“ˆ MACD: {recent['MACD']:.6f}")
    print(f"ğŸ“‰ ì‹œê·¸ë„: {recent['ì‹œê·¸ë„']:.6f}")

    print("\n" + "-" * 60)
    print("ğŸ’¡ ì‹ í˜¸:")
    print("-" * 60)

    # ì˜¤ì‹¤ë ˆì´í„° ì‹ í˜¸
    signal = "ğŸŸ¢ ê°•ì„¸" if recent["ì˜¤ì‹¤ë ˆì´í„°"] > 0 else "ğŸ”´ ì•½ì„¸"
    if recent["ì˜¤ì‹¤ë ˆì´í„°"] > 0 and prev["ì˜¤ì‹¤ë ˆì´í„°"] <= 0:
        signal += " âš¡ ê³¨ë“ í¬ë¡œìŠ¤!"
    elif recent["ì˜¤ì‹¤ë ˆì´í„°"] < 0 and prev["ì˜¤ì‹¤ë ˆì´í„°"] >= 0:
        signal += " âš¡ ë°ë“œí¬ë¡œìŠ¤!"
    print(f"1. ì˜¤ì‹¤: {signal}")

    # MACD ì¶”ì„¸
    print(f"2. MACD: {'ğŸŸ¢ ë‹¨ê¸°â†‘' if recent['MACD'] > 0 else 'ğŸ”´ ë‹¨ê¸°â†“'}")

    # ìˆ˜ê¸‰
    print(f"3. ìˆ˜ê¸‰: {'ğŸŸ¢ ìˆœë§¤ìˆ˜' if recent['ìˆ˜ê¸‰ë¹„ìœ¨'] > 0 else 'ğŸ”´ ìˆœë§¤ë„'}")

    # ëª¨ë©˜í…€
    momentum = df.tail(5)["ì˜¤ì‹¤ë ˆì´í„°"].diff().sum()
    print(f"4. 5ì¼ ëª¨ë©˜í…€: {momentum:+.6f} {'ğŸŸ¢â†‘' if momentum > 0 else 'ğŸ”´â†“'}")
    print("=" * 60 + "\n")

# ============================================================================
# ì¢…ëª© ê²€ìƒ‰ í•¨ìˆ˜
# ============================================================================
def search_stock(name):
    """ì¢…ëª©ëª…ìœ¼ë¡œ ì½”ë“œ ê²€ìƒ‰"""
    print(f"ğŸ” '{name}' ê²€ìƒ‰ ì¤‘...")

    try:
        today = datetime.now().strftime("%Y%m%d")
        tickers = stock.get_market_ticker_list(
            today, market="KOSPI"
        ) + stock.get_market_ticker_list(today, market="KOSDAQ")
    except:
        yesterday = (datetime.now() - timedelta(days=1)).strftime("%Y%m%d")
        tickers = stock.get_market_ticker_list(
            yesterday, market="KOSPI"
        ) + stock.get_market_ticker_list(yesterday, market="KOSDAQ")

    # ê²€ìƒ‰
    matches = [
        (t, stock.get_market_ticker_name(t))
        for t in tickers
        if name.upper() in stock.get_market_ticker_name(t).upper()
        or stock.get_market_ticker_name(t).upper() in name.upper()
    ]

    if not matches:
        print(f"âŒ '{name}' ê²€ìƒ‰ ê²°ê³¼ ì—†ìŒ")
        return None

    if len(matches) == 1:
        ticker, sname = matches[0]
        print(f"âœ… {sname} ({ticker})\n")
        return ticker

    # ë‹¤ì¤‘ ì„ íƒ
    print(f"\nğŸ“‹ ê²€ìƒ‰ ê²°ê³¼ ({len(matches)}ê°œ):")
    for i, (t, n) in enumerate(matches, 1):
        print(f"  {i}. {n} ({t})")

    while True:
        try:
            idx = int(input(f"\nì„ íƒ (1-{len(matches)}): ")) - 1
            if 0 <= idx < len(matches):
                ticker, sname = matches[idx]
                print(f"âœ… {sname} ({ticker})\n")
                return ticker
        except (ValueError, KeyboardInterrupt):
            return None
        print(f"âŒ 1-{len(matches)} ì¤‘ ì„ íƒí•˜ì„¸ìš”.")

# ============================================================================
# ë©”ì¸ í•¨ìˆ˜
# ============================================================================
def main():
    """ë©”ì¸ ì‹¤í–‰"""
    print("=" * 60)
    print("ğŸš€ ìˆ˜ê¸‰ ì˜¤ì‹¤ë ˆì´í„° ë¶„ì„")
    print("=" * 60 + "\n")

    # ì¢…ëª© ê²€ìƒ‰
    name = input("ğŸ“ ì¢…ëª©ëª… (ì˜ˆ: ì‚¼ì„±ì „ì): ").strip()
    if not name:
        print("âŒ ì¢…ëª©ëª…ì„ ì…ë ¥í•˜ì„¸ìš”.")
        return

    ticker = search_stock(name)
    if not ticker:
        return

    stock_name = stock.get_market_ticker_name(ticker)

    # ê¸°ê°„ ì„¤ì •
    end = datetime.now()
    start = end - timedelta(days=ANALYSIS_DAYS)
    print(f"ğŸ“… ê¸°ê°„: {start:%Y-%m-%d} ~ {end:%Y-%m-%d}\n")

    try:
        # ë¶„ì„
        df = get_data(ticker, start.strftime("%Y%m%d"), end.strftime("%Y%m%d"))
        df = calc_oscillator(df)
        analyze(df)
        plot_chart(df, stock_name)

        print("âœ… ë¶„ì„ ì™„ë£Œ!\n")

        # CSV ì €ì¥
        if input("ğŸ’¾ CSV ì €ì¥? (y/n): ").lower() == "y":
            csv = f"{stock_name}_ìˆ˜ê¸‰_{datetime.now():%Y%m%d}.csv"
            df.to_csv(csv, encoding="utf-8-sig")
            print(f"âœ… ì €ì¥: {csv}")

    except Exception as e:
        print(f"\nâŒ ì˜¤ë¥˜: {e}")
        print("ì¢…ëª©ëª… ë˜ëŠ” ì¸í„°ë„· ì—°ê²°ì„ í™•ì¸í•˜ì„¸ìš”.")

if __name__ == "__main__":
    main()
